{% extends "../base.html" %} {%block title%}客户管理{%end%} {% block body %}

<!--<a class="btn btn-danger btn-sm delete " id="customer_delete" type="button" title="2776">删除</a>-->
<style>
.faye-table {width: 100%; height: auto; /*background-color: purple;*/ margin: 0% auto; font-weight: bold;}
.faye-table ul {overflow: hidden; margin: 0; padding: 0;}
.faye-table ul li {width: 100%; list-style: none; box-sizing: border-box; border-bottom: 1px solid #dedede; width: 100%; height:40px; overflow: hidden;}
.faye-table ul li div {float: left; height: 40px; line-height: 40px; text-align: center; border-left: 1px solid #dedede;}
.faye-table ul li div.fayet {width:10%; background-color:#eee; border-bottom: 1px solid #dedede; }
.faye-table ul li div.fayet1 {width:13%;}
.faye-table ul li div.fayet3 {width:92%;}
.faye-table ul li div.fayet4 {width:10%;}
.faye-table ul li div.fayet5 {width:15%;}
.faye-table ul li div.fayet6 {width:33%; height: 180px; border-left: 1px solid #dedede; }
.faye-table ul li div.fayet7 {width:34%; height: 180px; border-left: 1px solid #dedede;}
.faye-table ul li.gaodu {height: 180px;}
.faye-table ul li div.direction {text-align: left; padding-left: 10px; box-sizing: border-box;}
.faye-table ul li div.fayet6 span {display: block; width: 100%; height: 40px; border-bottom: 1px solid #dedede; background-color:#eee; }
.faye-table ul li div.fayet7 span {display: block; width: 100%; height: 40px; border-bottom: 1px solid #dedede; background-color:#eee; }
.faye-table ul li div.fayet6 i {display: block; width: 100%; height: 140px; line-height: 22px; font-style: normal; padding-top:8px; box-sizing: border-box;}
.faye-table ul li div.fayet7 i {display: block; width: 100%; height: 140px; line-height: 22px; font-style: normal; padding-top:8px; box-sizing: border-box;}
.message-item {
margin-bottom: 5px;
margin-left: 40px;
position: relative;
}
.message-item .message-inner {
background: #fff;
border: 1px solid #ddd;
border-radius: 3px;
padding: 10px;
position: relative;
}
.message-item .message-inner:before {
border-right: 10px solid #ddd;
border-style: solid;
border-width: 10px;
color: rgba(0,0,0,0);
content: "";
display: block;
height: 0;
position: absolute;
left: -20px;
top: 6px;
width: 0;
}
.message-item .message-inner:after {
border-right: 10px solid #fff;
border-style: solid;
border-width: 10px;
color: rgba(0,0,0,0);
content: "";
display: block;
height: 0;
position: absolute;
left: -18px;
top: 6px;
width: 0;
}
.message-item:before {
background: #fff;
border-radius: 2px;
bottom: -30px;
box-shadow: 0 0 3px rgba(0,0,0,0.2);
content: "";
height: 100%;
left: -30px;
position: absolute;
width: 3px;
}
.message-item:after {
background: #fff;
border: 2px solid #ccc;
border-radius: 50%;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
content: "";
height: 15px;
left: -36px;
position: absolute;
top: 10px;
width: 15px;
}
.clearfix:before, .clearfix:after {
content: " ";
display: table;
}
.message-item .message-head {
border-bottom: 1px solid #eee;
margin-bottom: 8px;
padding-bottom: 8px;
}
.message-item .message-head .avatar {
margin-right: 20px;
}
.message-item .message-head .user-detail {
overflow: hidden;
}
.message-item .message-head .user-detail h5 {
font-size: 16px;
font-weight: bold;
margin: 0;
}
.message-item .message-head .post-meta {
float: left;
padding: 0 15px 0 0;
}
.message-item .message-head .post-meta >div {
color: #333;
font-weight: bold;
text-align: right;
}
.post-meta > div {
color: #777;
font-size: 12px;
line-height: 22px;
}
.message-item .message-head .post-meta >div {
color: #333;
font-weight: bold;
text-align: right;
}
.post-meta > div {
color: #777;
font-size: 12px;
line-height: 22px;
}
.message-item img {
min-height: 25px;
max-height: 25px;
}
.modal-ku {
width: 1750px;
margin: auto;
}
</style>
<div class="main">
<div class="main-inner">
<div class="container">
<div class="row">
<div class="span12">
<div class="widget">
<div class="widget-header">
<i class="icon-user"></i>
<h3>客户详情
</h3>
</div>
<div class="widget-content">
		<div class="tabbable">
						<ul class="nav nav-tabs" id="myTab">
						  <li>
						    <a href="/customer?tag=show&id={{customer.id}}&guid={{customer.guid}}&to_tag=customer_tab" id="a_customer_tab" >基础信息</a>
						  </li>
              <li ><a href="/customer?tag=show&id={{customer.id}}&guid={{customer.guid}}&to_tag=finance_tab" id="a_finance_tab" >财务信息</a></li>
              <li><a href="/customer?tag=show&id={{customer.id}}&guid={{customer.guid}}&to_tag=exchange_tab" id="a_exchange_tab" >联系记录</a></li>

              <li class="active"><a href="#payment_tab" id="a_payment_tab" data-toggle="tab">应收记录</a></li>

						</ul>

						<br>

<div class="tab-content">
    <div class="tab-pane active " id="payment_tab ">

        <div class="widget widget-table action-table">




                    <div class="widget-content">







<div class="widget widget-table action-table">
<div class="widget-header"> <i class="icon-th-list"></i>
<h3>应收记录 </h3>
</div>
<div class="widget-content">
 {%if customers%}
<table class="table table-striped table-bordered">
    <thead>
        <tr style="background-color: black; color:#fff;">

            <th style="min-width:180px;">公司名称</th>



            <th style="min-width:50px;">付款方式</th>
            <th style="min-width:60px;">总服务费</th>
            <th style="min-width:60px;">月服务费</th>




            <th>帐册费</th>
            <th>记账费到期时间</th>
            <th>账册费到期时间</th>
            <th>本期收款明细</th>
            <th>未收明细</th>
            <th>更新时间</th>
            <th>更新人</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {%for idx,item in enumerate(customers)%}

        <tr>

            <td>{{item.company}}</td>
            <td>{{item.pay_pay_typeid_name}}</td>
            <td>{{item.pay_service_amount}}</td>
            <td>{{item.pay_service_amount_month}}</td>

            <td>{{item.pay_book_amount}}</td>
            <td>

                {%if item.acc_end%} {{item.acc_end.strftime("%Y-%m")}} {%end%}


            </td>
            <td> {%if item.acc_book_end %} {{item.acc_book_end.strftime("%Y-%m")}} {%end%}</td>
            <td>
     {%if item.al_remark%} {{(item.al_remark)}} {%end%}

            </td>
            <td>
                
                {%if item.pb_remark%}
                {{(item.pb_remark)}}
                {%end%}

            </td>
            <td>{%if item.created_at%} {{item.created_at.strftime("%Y-%m-%d")}} {%end%}</td>
            <td>
                
                {%if item.pay_uid_name%}
                {{(item.pay_uid_name)}}
                {%end%}
            
            </td>
            <th>{%if idx==0%}
             <a class="btn handler_detail btn-sm control" type='button'
        customer_id="{{item.customer_id}}"
        item_id="{{item.id}}"
        wait_pay="{%if item.acc_end and  item.acc_end.strftime("%Y-%m")==dt_next.strftime("%Y-%m")%}{{item.next_pay_acc_start.strftime("%Y-%m")}}至{{item.next_pay_acc_end.strftime("%Y-%m")}}({{item.pay_pay_typeid_name}})记账费:{{item.pay_service_amount}}元 {%end%}{%if item.acc_book_end and item.acc_book_end.strftime("%Y-%m")==dt_next.strftime("%Y-%m")%}{{item.next_pay_acc_book_start.strftime("%Y-%m")}}至{{item.next_pay_acc_book_end.strftime("%Y-%m")}}({{item.pay_pay_typeid_name}})账册费:{{item.pay_book_amount}}元{%end%}"
            href="javascript:void(0)"
     curr_expire_pay="{%if item.acc_end and item.acc_end.strftime("%Y-%m")==dt_next.strftime("%Y-%m")%}记账费到期:{{item.acc_end.strftime("%Y-%m")}}
    {%end%}{%if item.acc_book_end and item.acc_book_end.strftime("%Y-%m")==dt_next.strftime("%Y-%m")%}账册费到期:{{item.acc_book_end.strftime("%Y-%m")}}{%end%}"
    href="javascript:void(0)"
    company_name="{{item.company}}"
    acc_end ="{%if item.acc_end%}{{item.acc_end.strftime("%Y-%m")}}{%end%}"
    acc_book_end = "{%if item.acc_book_end%}{{item.acc_book_end.strftime("%Y-%m")}}{%end%}"
    pb_remark = "{%if item.pb_remark%}}{{item.pb_remark}}{%end%}"
    al_remark="{%if item.al_remark%}{{item.al_remark}}{%end%}"
    >编辑</a>{%end%}</th>
        </tr>
        {%end%}



    </tbody>
</table>

{%else%} 还没有客户哦。 {%end%}

</div>
<!-- /widget-content -->
</div>


                    </div>
                    <!-- /widget-content -->
</div>

<div class="widget widget-table action-table">
    <div class="widget-header">
        <i class="icon-th-list"></i>
        <h3>催款记录 </h3>
    </div>
    <div class="widget-content">
        <textarea class="form-control" id="txt_msg" style="width:80%">
                                                                      </textarea>
         <input type="text" id="txt_time" placeholder="催款时间"/> 
                                                                      <br/>
        <button id="btn_save_msg">确定添加</button>&nbsp;&nbsp;&nbsp;
        <input type="file" value="上传附件" style=margin-top:10px;" name="record_file" id="record_file" class="form-control "/>
                                                                      <hr class="my-0">
                                                                      {%for item in t_customer_exchange%}
                                                                      <div class="message-item" id="msg_{{item.id}}">
                                                                          <div class="message-inner">
                                                                              <div class="message-head clearfix">
                                                                                  <div class="avatar pull-left">
                                                                                      <img src="/static/images/avatar.jpeg">
                                                                                  </div>
                                                                                  <div class="user-detail">
                                                                                      <h5 class="handle">{{item.uid_name}}
                                                                                          <span style="font-size:13px;"> {{item.created_at}}
                                                                                            <span style="color:red;">{%if item.msg_time%}({{item.msg_time}}){%end%}</span>
                                                                                          </span>
                                                                                          {%if item.file_path%}
                                                                                          <a href="{{item.file_path}}" target="_blank"> 查看附件</a>
                                                                                          {%end%}
                                                                                      </h5>
                                                                                  </div>
                                                                              </div>
                                                                              {{item.msg}}<span style="color:red;">{%if item.summary%}(总结:{{item.summary}}){%end%}</span>
                                                                          </div>
                                                                      </div>
                                                                      {%end%}
    </div>
    <!-- /widget-content -->
</div>



                  </div>
        </div>
</div>


<div id="a_handler_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel_account">发起待收


        </h3>
    </div>
    <div class="modal-body">
        <div class="control-group">

            <table border="1" style="padding:10px;">


                <tr style="background:#ccc;">
                    <td colspan="8">公司名称</td>
                </tr>
                <tr id="company_name">

                </tr>
                <tr style="background:#ccc;">
                    <td colspan="8">当前收款基本信息</td>
                </tr>
                <tr id="service_price">

                </tr>

                <tr style="background:#ccc;">
                    <td colspan="8">上期收款明细</td>
                </tr>
                <tr id="last_payment">

                </tr>
                <tr style="background:#ccc;">
                    <td colspan="8">到期信息</td>
                </tr>
                <tr id="curr_expire">

                </tr>
                <!--  <tr style="background:#ccc;">
        <td colspan="8">本期到款明细</td>
    </tr>
    <tr id="curr_payment_detail">

    </tr>
-->
            </table>

<div class="control-group">

    <label class="control-label" for="acc_end">记账费到期时间

    </label>
    <div class="controls">
        <input type="text" class="span4 " id="acc_end" name="acc_end" value="">
        <p id="msg_acc_end" class="help-block" style="color:red"></p>
    </div>
    <!-- /controls -->
</div>
<div class="control-group">

    <label class="control-label" for="account">账册费到期时间

    </label>
    <div class="controls">
        <input type="text" class="span4 " id="acc_book_end" name="acc_book_end" value="">
        <p id="msg_acc_book_end" class="help-block" style="color:red"></p>
    </div>
    <!-- /controls -->
</div>



<div class="control-group">
    <label class="control-label" for="al_remark">已收明细</label>
    <div class="controls">
        <textarea type="text" class="span4" id="al_remark" name="al_remark" value="" style="height: 50px;"></textarea>
    </div>
    <!-- /controls -->
</div>
<div class="control-group">
    <label class="control-label" for="lastname">待收明细</label>
    <div class="controls">
        <textarea type="text" class="span4" id="pb_remark" name="pb_remark" value="" style="height: 50px;"></textarea>
    </div>
    <!-- /controls -->
</div>



        </div>

    </div>
    <div class="modal-footer">

        <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
        <button class="btn btn-primary" id="btn_save_wai_pay">保存</button>
    </div>
</div>


    {%end%}

    {% block  js %}
    <script>
        $(function(){

           var customer_id = {{ customer.id }}
           var customer_guid = "{{customer.guid}}"
            $('#a_{{to_tag}}').tab('show');
           _xsrf = getCookie("_xsrf")

            laydate.render({
                    elem: '#txt_time' //指定元素
           });


        $("#btn_save_wai_pay").on("click",function () { 
                acc_end=$("#acc_end").val()
                acc_book_end=$("#acc_book_end").val()
                al_remark=$("#al_remark").val()
                pb_remark=$("#pb_remark").val()
                pay_id=$(this).attr("pay_id")
                $.post("payment?tag=add",
                {
                    "_xsrf":_xsrf,
                    "acc_end":acc_end,
                    "acc_book_end":acc_book_end,
                    "al_remark":al_remark,
                    "pb_remark":pb_remark,
                    "pay_id":pay_id,
                    "customer_id":customer_id
                },function (result) { 
                        location.reload()
                 })
             })

        laydate.render({
            elem: '#acc_end'  , type: 'month'//指定元素
        });

        laydate.render({
            elem: '#acc_book_end', type: 'month' //指定元素
        });
        $(".handler_detail").on("click", function () {

            wait_pay = $(this).attr("wait_pay")
            curr_expire_pay = $(this).attr("curr_expire_pay")


            acc_book_end = $(this).attr("acc_book_end")
            acc_end= $(this).attr("acc_end")
            $("#acc_book_end").val(acc_book_end)
            $("#acc_end").val(acc_end)
            
            al_remark = $(this).attr("al_remark")
            pb_remark = $(this).attr("pb_remark")

           $("#al_remark").val(al_remark)
            $("#pb_remark").val(pb_remark)


            company_name = $(this).attr("company_name")
            $("#btn_save_wai_pay").attr("pay_id", "0")
            $("#curr_expire").text("")
            $("#last_payment").html("")
            $("#curr_last_payment").html("")
            $("#service_price").html("")
            $("#account_remark").val("")
            $("#company_name").text("")
           
            $.get("/payment?tag=get_last_payment", { "customer_id": customer_id }, function (result) {
                if (result.code == 1) {

                    html = "<td>付款方式</td><td>" + result.customer.customer_paytype_id_name + "</td>"
                    html += "<td>总服务费</td><td>" + result.customer.customer_service_amount + "</td>"
                    html += "<td>月服务费</td><td>" + result.customer.customer_service_amount_month + "</td>"
                    html += "<td>账册费</td><td>" + result.customer.customer_book_amount + "</td>"
                    $("#service_price").html(html)
                    // $("#msg_service_amount").text("上一次总服务费:" +  result.customer.service_amount)

                    $("#msg_acc_end").text("(上期记账费到期时间:" + result.customer.acc_end + ")")
                    $("#msg_acc_book_end").text("(上期账册费到期时间:" + result.customer.acc_book_end + ")")

                    if (result.customer.al_remark == undefined || result.customer.al_remark == "") {
                        $("#last_payment").html("<td colspan='8'>没有上期收款明细哦</td>")

                    } else {
                        $("#last_payment").html("<td colspan='8'>" + result.customer.al_remark + "</td>")
                    }
                    if (result.customer.pb_remark == undefined || result.customer.pb_remark == "") {
                        $("#curr_last_payment").html("<td colspan='8'>没有待收款明细哦</td>")

                    } else {
                        $("#curr_last_payment").html("<td colspan='8'>" + result.customer.pb_remark + "</td>")
                    }

                    $("#curr_expire").html("<td colspan='8'>" + curr_expire_pay + "</td>")
                    $("#company_name").html("<td colspan='8'>" + company_name + "</td>")

                    $("#btn_save_wai_pay").attr("pay_id", result.customer.payment_id)


                    $("#wait_pay_remark").val(wait_pay)
                    $("#a_handler_modal").modal("show")
                } else {


                }
            }, "json")


        })




           
            function intToFloat(val) {
                return new Number(val).toFixed(2);
            }
            $('input[type="radio"][name="pay_type_id"]').click(function () {
                service_amount = $("#service_amount").val()
                if ($(this).is(':checked')) {
                    all_total = service_amount / $(this).attr("fee");
                    if(all_total==Infinity){
                        $("#service_month_amount").val(0)
                    }else{
                    $("#service_month_amount").val(intToFloat(all_total))
                    }
                }
            });

            $('#service_amount').keyup(function () {
                all_total = $(this).val() / $("input[name='pay_type_id']:checked").attr("fee");
                $("#service_month_amount").val(intToFloat(all_total))


            });
                $("#btn_save_msg").on("click", function () {
                msg = $("#txt_msg").val()
                if (msg == "") {
                    alert("交流记录不能为空哦.")
                    return false
                } else {
                    $(this).attr("disabled", "disabled")
                    var formData = new FormData();
                    formData.append('file', $('#record_file')[0].files[0])
                    formData.append('_xsrf', _xsrf)
                    formData.append('msg', msg)
                    formData.append('customer_id', customer_id)
                    formData.append('msg_time',$('#txt_time').val())
                    formData.append('etype', 2)

                    $.ajax({
                        url: '/customer?tag=customer_exchange',
                        type: 'POST',
                        data: formData,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        success: function (data) {
                            location.href = "/payment?tag=customer&customer_id=" + customer_id + "&to_tag=payment_tab"
                        }
                    })
                }


            })
          

      });

    </script>
    {% end %}