 {% extends "../base.html" %} {%block title%}客户管理{%end%} {% block body %}

<div class="main">
    <div class="main-inner">
        <div class="container">
            <div class="row">
                <div class="span12">
                    <div class="widget ">
                        <div class="widget-header">
                            <i class="icon-user"></i>
                            <h3>记账应收管理 {% include "payment_nav.html" %}


                            </h3>

                        </div>



                        <!-- /widget-header -->
                        <div class="widget-content">
                            <div class="tab-content">
                                <div class="tab-pane active" id="formcontrols">

                                    <fieldset>
                                            <form class="form-search" id="query_form">
                                                    <input type="text" value="{{company}}" name="company" class="input-medium seexpire_customerarch-query" placeholder="公司名称">
                                                  
                                                    <button type="submit" class="btn">检 索</button>
                                                    <input type="hidden" value="{{tag}}" name="tag"/>
                                                <input type="hidden" value="{{show_tag}}" name="show_tag" />
                                                <input type="hidden" value="{{by_tag}}" name="by_tag" />




                                                  </form>

                                                 

<ul class="nav nav-tabs" id="myTab">

    <li {%if show_tag=="1" %} class="active" {%end%}>
        <a href="/payment?tag=expire_customer&show_tag=1" id="customer_tab">待处理</a>
    </li>



    <li {%if show_tag=="2"%} class="active" {%end%}>
        <a href="/payment?tag=expire_customer&show_tag=2" id="tab_confirm">已处理</a>
    </li>
</ul>

 {%if show_tag=="1"%}
                <ul class="nav nav-tabs" id="myTab">


                    
<li {%if show_tag=="1"  and not by_tag%} class="active" {%end%}>
    <a href="/payment?tag=expire_customer&show_tag=1" id="customer_tab">全部</a>
</li>

                    <li {%if show_tag=="1" and by_tag=="正常" %} class="active" {%end%}>
                        <a href="/payment?tag=expire_customer&by_tag=正常" id="customer_tab">正常</a>
                    </li>
                    <li {%if show_tag=="1" and by_tag=="解约" %} class="active" {%end%}>
                        <a href="/payment?tag=expire_customer&by_tag=解约" id="customer_tab">解约</a>
                    </li>
                
                
                    <li {%if show_tag=="1" and by_tag=="停账" %} class="active" {%end%}>
                        <a href="/payment?tag=expire_customer&by_tag=停账" id="customer_tab">停账</a>
                    </li>
                
                
                
                    <li {%if show_tag=="1" and by_tag=="注销" %} class="active" {%end%}>
                        <a href="/payment?tag=expire_customer&by_tag=注销" id="customer_tab">注销</a>
                    </li>
                
                    <li {%if show_tag=="1" and by_tag=="逾期" %} class="active" {%end%}>
                        <a href="/payment?tag=expire_customer&by_tag=逾期" id="customer_tab">逾期</a>
                    </li>
                </ul>

{%end%}


                                        <div class="alert">
                                        
                           
                                                                                         当前数量: {{pagination.total_count}}

                                        </div>

                                        {%if customers%}

                                        <table class="table" style="margin:5px;">
                                            <thead>
                                                <tr style="background-color: black; color:#fff;">
                                                    <th style="width:20px;"></th>

                                                    <th style="min-width:150px;">公司名称</th>


                                                                                                        <th style="min-width:40px;">会计</th>

                                                    <th style="min-width:50px;">付款方式</th>

                                                    <th style="min-width:30px;">总服务费</th>
                                                    <th style="min-width:60px;">月服务费</th>




                                                    <th>帐册费</th>
                                                    <th>记账费到期</th>
                                                    <th>账册费到期</th>
                                                    <th width="160">最新收款明细</th>
                                                    <th width="160">待收明细</th>
 {%if show_tag=="1"%}<th width="60"></th>{%end%}

 {%if show_tag=="2"%}
<th width="60"></th>{%end%}

                                                </tr>
                                            </thead>
                                            <tbody>

                                                {%for item in customers%}
                                                <tr>


                                              
        <td>
        <a class="modify_customer_detail btn-sm control"
         customer_id="{{item.customer_id}}" 
         promo_id="{{item.promo_id}}|{{item.promo_id_name}}" is_general="{{item.is_general}}"
         pay_pay_typeid_name="{{item.pay_pay_typeid_name}}"
         pay_service_amount = "{{item.pay_service_amount}}"
         pay_service_amount_month  = "{{item.pay_service_amount_month}}"
         pay_book_amount ="{{item.pay_book_amount}}" guid="{{item.guid}}"
         customer_type="{{item.customer_type}}"  href="javascript:void(0)"
        >
            <img src="/static/images/modify.png" width="20"/></a>
        
        </td>
                                                    <td>
                                                        <a href="/customer?tag=show&id={{item.customer_id}}&guid={{item.guid}}">{{item.company}}</a>

                                                    </td>
                                                     <td>{{item.acc_uid_name}}</td>
                                                    <td>{{item.pay_pay_typeid_name}}</td>
                                                    <td>{{item.pay_service_amount}}</td>
                                                    <td>{{item.pay_service_amount_month}}</td>

                                                    <td>{{item.pay_book_amount}}</td>

                                                    <td {%if item.acc_end and  compare_date(item.acc_end,dt_next)%} style="background-color:lemonchiffon" {%end%}>
                                                        {%if item.acc_end%} {{item.acc_end.strftime("%Y-%m")}} {%end%}

                                                  
                                                    </td>
                                                    <td  {%if item.acc_book_end and  compare_date(item.acc_book_end,dt_next)%} style="background-color:lemonchiffon" {%end%}>

                                                        {%if item.acc_book_end %} {{item.acc_book_end.strftime("%Y-%m")}} {%end%}
                                                    </td>
                                                       <td>{%if item.al_remark%}{{item.al_remark}}{%end%}</td>
  <td>{%if item.pb_remark%}{{item.pb_remark}}{%end%}</td>


 {%if show_tag=="1"%}
<td>
<a class="btn handler_detail btn-sm control" type='button'
customer_id="{{item.customer_id}}"
item_id="{{item.id}}"
cp_title_id="{{item.cp_title_id}}"

wait_pay="{%if item.acc_end and   compare_date(item.acc_end,dt_next)%}{{item.next_pay_acc_start.strftime("%Y-%m")}}至{{item.next_pay_acc_end.strftime("%Y-%m")}}({{item.pay_pay_typeid_name}})记账费:{{item.pay_service_amount}}元 {%end%}{%if item.acc_book_end and  compare_date(item.acc_book_end,dt_next)%}{{item.next_pay_acc_book_start.strftime("%Y-%m")}}至{{item.next_pay_acc_book_end.strftime("%Y-%m")}}({{item.pay_pay_typeid_name}})账册费:{{item.pay_book_amount}}元{%end%}"
     last_waitpay_expire = "{{item.pb_remark}}"
    href="javascript:void(0)"
     curr_expire_pay="{%if item.acc_end and compare_date(item.acc_end,dt_next)%}记账费到期:{{item.acc_end.strftime("%Y-%m")}}
    {%end%}{%if item.acc_book_end and  compare_date(item.acc_book_end,dt_next)%}账册费到期:{{item.acc_book_end.strftime("%Y-%m")}}{%end%}"
    
    href="javascript:void(0)"
    company_name="{{item.company}}"
    
    >
     发起</a>

 
</td>

{%if show_tag=="2"%}
<td></td>{%end%}
                {%end%}

                                                </tr>
                                                {%end%}



                                            </tbody>
                                        </table>

                                        {%else%} 还没有客户哦。 {%end%}
                                        <div class="pagination">
                                            <ul>
                                                {% if pagination.has_prev %}
                                                <li>
                                                    <a href="/payment?tag={{tag}}&page={{ pagination.page - 1}}{%if show_tag%}&show_tag={{show_tag}}{%end%}{%if by_tag%}&by_tag={{by_tag}}{%end%}">&laquo; 上页</a>
                                                </li> {% end %} {%for page in pagination.iter_pages() %} {% if page %} {% if page != pagination.page %}
                                                <li>
                                                    <a href="/payment?tag={{tag}}&page={{ page }}{%if show_tag%}&show_tag={{show_tag}}{%end%}{%if company%}&company={{company}}{%end%}{%if by_tag%}&by_tag={{by_tag}}{%end%}">{{ page }}</a>
                                                </li>
                                                {% else %}
                                                <li>
                                                    <span class="active">
                                                        <a href="#">{{ page }}</a>
                                                    </span>
                                                </li>
                                                {% end %} {% else %}
                                                <li>
                                                    <span class="active">
                                                        <a href="#">....</a>
                                                    </span>
                                                </li>
                                                {% end %} {%end %} {% if pagination.has_next %}
                                                <li>
                                                    <a href="/payment?tag={{tag}}&page={{pagination.page+1}}{%if show_tag%}&show_tag={{show_tag}}{%end%}{%if company%}&company={{company}}{%end%}{%if by_tag%}&by_tag={{by_tag}}{%end%}">下页 &raquo;</a>
                                                </li>
                                                {% end %}
                                            </ul>
                                        </div>
                                    </fieldset>

                                </div>



                            </div>
                        </div>
                    </div>
                </div>
                <!-- /widget-content -->
            </div>
            <!-- /widget -->
        </div>
        <!-- /span8 -->
    </div>
    <!-- /row -->
</div>
<!-- /container -->
</div>

<div id="a_handler_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel_account">发起待收</h3>
    </div>
    <div class="modal-body">
        <div class="control-group">

<table border="1" style="padding:10px; width:100%">

     
    <tr style="background:#ccc;">
        <td colspan="8">公司名称</td>
    </tr>
    <tr id="company_name">
    
    </tr>
    <tr style="background:#ccc;">
        <td colspan="8">当前收款基本信息</td>
    </tr>
    <tr id="service_price">

    </tr>

    <tr style="background:#ccc;">
        <td colspan="8">上期收款明细</td>
    </tr>
    <tr id="last_payment">

    </tr>
   <tr style="background:#ccc;">
        <td colspan="8">到期信息</td>
    </tr>
 <tr id="curr_expire">

    </tr>

<tr style="background:#ccc;font-size:18px; color:red;font-weight:bolder;">
    <td colspan="8">上期待收明细 <button id="insert_totxt">加入本期待收</button></td>
</tr>
<tr id="last_waitpay_expire" style="font-size:16px; color:red;font-weight:bolder;">

</tr>


</table>


        <div class="control-group">
            <label class="control-label" for="lastname">最新应收明细<span style="font-size:12px; color:red;font-weight:bolder;">(表示到目前为止客户所有记账欠款明细)</span>
            
           
            </label>
            <div class="controls">
                <textarea type="text" class="span5" id="wait_pay_remark" name="wait_pay_remark" value="" style="height: 50px; color:darkblue;font-size:14px;"></textarea><br/>
                <input type="checkbox" name="req_close" id="req_close" value="1" /> 无应收订单
            </div>
            <!-- /controls -->
        </div>

                    <div class="controls">
                        <label class="control-label" for="lastname">待收金额</label>
                                    <div class="controls">

                        <input type="text" id="wait_pay_amount" name="wait_pay_amount" placeholder="待收金额" />
            </div>

                     </div>


<span style="font-size:14px; color:red;font-weight:bolder;">

    * 注意检查最新应收明细是否遗漏之前未收应收.

</span>
</div>

    </div>
    <div class="modal-footer">
   
        <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
        <button class="btn btn-primary" id="btn_save_wai_pay">保存</button>
    </div>
</div>


<div id="a_customer_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel_account">修改基础数据


        </h3>
    </div>
    <div class="modal-body">
        <div class="control-group">
            <label for="promo_id" class="control-label">优惠活动:
            </label>
            <div class="controls">
                <select name="promo_id" id="promo_id" class="form-control">
                    <option value="0">==请选择优惠活动==</option>
                    {% for idx, item in enumerate(t_promo_types) %}
        
                    <option value="{{item.id}}|{{item.income_name}}">
                        {{item.income_name}}
                    </option>
                    {% end %}
                </select>
            </div>
        </div>
        
        
        <div class="control-group">
            <label class="control-label" for="is_general">是否一般纳税人</label>
            <div class="controls">
                <input type="radio" name="is_general" value="1" /> 是
                <input type="radio" name="is_general" value="0" /> 否
                <p id="msg_is_general" class="help-block" style="color:red"></p>
            </div>
            <!-- /controls -->
        </div>



                <div class="control-group">
                    <label class="control-label" for="is_general">客户类型
                    </label>
                    <div class="controls">
                        {%for item in t_customer_type%}
                        <input type="checkbox" name="customer_type" value="{{item.id}}" title="{{item.name}}"
                        /> {{item.name}} {%end%}
                        <p id="msg_t_customer_type" class="help-block" style="color:red"></p>
                    </div>
                    <!-- /controls -->
                </div>
                
                
                
                <div class="control-group">
                    <label class="control-label" for="is_general">付款方式
                    </label>
                    <div class="controls">
                        {%for idx,item in enumerate(t_payment_type)%}
                        <input type="radio" name="pay_type_id" fee="{{item.fee}}" value="{{item.id}}" pay_typeid_name="{{item.name}}"/> {{item.name}} {%end%}
                
                        <p id="msg_paytype" class="help-block" style="color:red"></p>
                    </div>
                    <!-- /controls -->
                </div>
                <div class="control-group">
                    <label class="control-label" for="lastname">总服务费</label>
                    <div class="controls">
                        <input type="text" class="span6" id="service_amount" name="service_amount" value="">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label" for="lastname">月服务费</label>
                    <div class="controls">
                        <input type="text" disabled="true" class="span6" id="service_amount_month" name="service_amount_month" value="">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label" for="lastname">帐册费</label>
                    <div class="controls">
                        <input type="text" class="span6" id="book_amount" name="book_amount" value="">
                    </div>
                </div>


    </div>
    <div class="modal-footer">

        <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
        <button class="btn btn-primary" id="btn_save_customer">保存</button>
    </div>
</div>


{%end%} {%block js%}

<script>

     $(function () {
            _xsrf = getCookie("_xsrf")

            $("#insert_totxt").on("click",function(){
                txt = $("#last_waitpay_expire").text()
                
                
                
                
                $("#wait_pay_remark").val($("#wait_pay_remark").val()+"\n"+txt)
                
            })

          $("#req_close").change(function () {
             if (this.checked) {
                 $("#wait_pay_remark").val("")
             }else{
                
                  $("#wait_pay_remark").val($("#btn_save_wai_pay").attr("waipay"))
             }
         });
            $("#btn_save_wai_pay").on("click",function(){
               // btn_save_wai_pay =  $("#btn_save_wai_pay").attr("waipay")
                payment_id = $(this).attr("payment_id")
                wait_pay_remark = $("#wait_pay_remark").val()
                req_close = $("#req_close:checked").val()
                wait_pay_amount = $("#wait_pay_amount").val()
                if(wait_pay_remark=="" && undefined== req_close){
                    alert("待收明细不能为空!")
                }
                else if(wait_pay_amount=="" || (wait_pay_amount=="0" && req_close==undefined)){
                    alert("待收金额不能为空或0哦!")
                }
                else{
                    if (req_close==undefined){
                        req_close = 0
                    }
                    $.post("/payment?tag=save_payment",{"pb_remark": wait_pay_remark,"_xsrf":_xsrf,"payment_id": payment_id,"req_close": req_close,"wait_pay_amount": wait_pay_amount},function(result){

                        location.reload()

                    })

                }
            })



            $(".modify_customer_detail").on("click",function(){
                    customer_id = $(this).attr("customer_id")
                    promo_id = $(this).attr('promo_id')
                    is_general = $(this).attr("is_general")
                    customer_type = $(this).attr('customer_type').split(',')
                    guid=$(this).attr('guid')
                    pay_pay_typeid_name = $(this).attr('pay_pay_typeid_name')
                    pay_service_amount = $(this).attr("pay_service_amount")
                    pay_service_amount_month =$(this).attr("pay_service_amount_month")
                    pay_book_amount = $(this).attr("pay_book_amount")
                    $("#customer_id").val(customer_id)
                    $("#promo_id").val(promo_id)
                    $("input[name=is_general]").prop('checked',false)
                    $("input[name=is_general][value="+is_general+"]").prop('checked',true)
                    $('input[name=customer_type]').prop('checked',false)
                    for(var i=0;i<customer_type.length;i++){
                        $('input[name=customer_type][value='+customer_type[i]+']').prop('checked',true)
                    }
                    $("input[name=pay_type_id]").prop('checked',false)
                    $("input[name=pay_type_id][pay_typeid_name="+pay_pay_typeid_name+"]").prop('checked',true)
                    $("#service_amount").val(pay_service_amount)
                    $("#service_amount_month").val(pay_service_amount_month)
                    $("#book_amount").val(pay_book_amount)
                    $("#btn_save_customer").attr("customer_id", customer_id)
                    $("#btn_save_customer").attr("guid", guid)



                    $("#a_customer_modal").modal("show")

            })



            $("#btn_save_customer").on("click",function(){
                customer_id = $(this).attr('customer_id')
                promo_id = $("#promo_id").val()
                is_general = $("input[name=is_general]:checked").val()
                var customer_type = ""
                var customer_type_name ="" 
                guid=$(this).attr('guid')
                $('input[name=customer_type]:checked').each(function () { 
                    customer_type_name= customer_type_name +$(this).attr("title")+","
                    customer_type = customer_type+$(this).val()+","
                 })
                 pay_type_id = $("input[name=pay_type_id]:checked").val()
                 pay_typeid_name =$("input[name='pay_type_id']:checked").attr("pay_typeid_name")
                 fee=$("input[name='pay_type_id']:checked").attr("fee")
                 service_amount = $("#service_amount").val()
                 service_amount_month = $("#service_amount_month").val()
                 book_amount = $("#book_amount").val()
                 $.post('/payment?tag=edit_basic_data',{
                     "_xsrf":_xsrf,
                     'customer_id':customer_id,
                     'promo_id':promo_id,
                     'customer_type_name':customer_type_name,
                     'customer_type':customer_type,
                     'pay_type_id':pay_type_id,
                     'pay_typeid_name':pay_typeid_name,
                     'service_amount':service_amount,
                     'service_amount_month':service_amount_month,
                     'book_amount':book_amount,
                     'is_general':is_general,
                     'guid':guid,
                     'fee':fee

                 },function (res) { 
                     location.reload()
                  })




            })

            $(".handler_detail").on("click", function () {
                $("#wait_pay_amount").val("")
                 $("#req_close").prop("checked", false)
                wait_pay = $(this).attr("wait_pay")
                $("#btn_save_wai_pay").attr("waipay", wait_pay )

                curr_expire_pay = $(this).attr("curr_expire_pay")
                customer_id = $(this).attr("customer_id")
                company_name = $(this).attr("company_name")
                last_waitpay_expire = $(this).attr("last_waitpay_expire")
                $("#btn_save_wai_pay").attr("payment_id", "0")
                $("#wait_pay_remark").val("")
                $("#curr_expire").text("")
                $("#last_payment").html("")
                $("#curr_last_payment").html("")
                $("#service_price").html("")
                 $("#account_remark").val("")
                $("#company_name").text("")
                $("#insert_totxt").hide()
                if(last_waitpay_expire=="None"){
                   
                       $("#last_waitpay_expire").html("<td colspan='8'>无</td>")
                }else{
                          $("#last_waitpay_expire").html("<td colspan='8'>" + last_waitpay_expire + "</td>")
                          $("#insert_totxt").show()

                }
               


                $.get("/payment?tag=get_last_payment", { "customer_id": customer_id }, function (result) {
                    if (result.code == 1) {
                        
                        html = "<td>付款方式</td><td>" + result.customer.customer_paytype_id_name + "</td>"
                        html += "<td>总服务费</td><td>" + result.customer.customer_service_amount + "</td>"
                        html += "<td>月服务费</td><td>" + result.customer.customer_service_amount_month + "</td>"
                        html += "<td>账册费</td><td>" + result.customer.customer_book_amount + "</td>"
                        $("#service_price").html(html)
                        // $("#msg_service_amount").text("上一次总服务费:" +  result.customer.service_amount)

                        $("#msg_acc_end").text("(上期记账费到期时间:" + result.customer.acc_end + ")")
                        $("#msg_acc_book_end").text("(上期账册费到期时间:" + result.customer.acc_book_end + ")")

                        if (result.customer.al_remark == undefined || result.customer.al_remark == "") {
                            $("#last_payment").html("<td colspan='8'>没有上期收款明细哦</td>")

                        } else {
                            $("#last_payment").html("<td colspan='8'>" + result.customer.al_remark + "</td>")
                        }
                        if (result.customer.pb_remark == undefined || result.customer.pb_remark == "") {
                            $("#curr_last_payment").html("<td colspan='8'>没有待收款明细哦</td>")

                        } else {
                            $("#curr_last_payment").html("<td colspan='8'>" + result.customer.pb_remark + "</td>")
                        }
                        
                       $("#curr_expire").html("<td colspan='8'>" + curr_expire_pay + "</td>")
                        $("#company_name").html("<td colspan='8'>" + company_name + "</td>")

                        $("#btn_save_wai_pay").attr("payment_id", result.customer.payment_id)

                        
                        $("#wait_pay_remark").val(wait_pay)
                        $("#a_handler_modal").modal("show")
                    } else {


                    }
                }, "json")
                

            })

    $('input[type="radio"][name="pay_type_id"]').click(function(){
                   
                   service_amount = $("#service_amount").val()
                   if ($(this).is(':checked'))
                   {
                      if($(this).attr("fee")>0){
                            $("#service_amount").removeAttr("readOnly")
                          
                       }else{
                            $("#service_amount").val("0")
                           all_total = 0
                       }
   
   
                       all_total =  service_amount / $(this).attr("fee");
                       console.log(all_total)
                       if (all_total==Infinity){
                           all_total = 0
   
                       }
                       $("#service_amount_month").val(intToFloat(all_total))
                   }
       });
   
          $('#service_amount').keyup(function() {
                           all_total = $(this).val() / $("input[name='pay_type_id']:checked").attr("fee");
                             if (all_total==Infinity){
                           all_total = 0
                           
                       }
                           $("#service_amount_month").val(intToFloat(all_total))
   
   
           });
   
   function intToFloat(val){
           return new Number(val).toFixed(2);
   }
    })
</script> {%end%}
